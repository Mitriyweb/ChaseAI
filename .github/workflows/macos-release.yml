# macOS Release Workflow
# Automatically builds and releases ChaseAI when a version tag is pushed
# Tags should follow the format: v1.0.0

name: macOS Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # Also allow manual trigger

jobs:
  check-version:
    name: Verify Version Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      file-version: ${{ steps.check-file.outputs.version }}
      version-match: ${{ steps.compare-versions.outputs.match }}
      should-release: ${{ steps.check-release.outputs.should-release }}
      release-exists: ${{ steps.check-existing-release.outputs.exists }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: extract-version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $VERSION"

      - name: Check .version file
        id: check-file
        run: |
          FILE_VERSION=$(cat .version | tr -d '[:space:]')
          echo "version=$FILE_VERSION" >> $GITHUB_OUTPUT
          echo ".version file: $FILE_VERSION"

      - name: Compare versions
        id: compare-versions
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          FILE_VERSION=$(cat .version | tr -d '[:space:]')
          if [ "$TAG_VERSION" = "$FILE_VERSION" ]; then
            echo "match=true" >> $GITHUB_OUTPUT
            echo "✓ Versions match: $TAG_VERSION"
          else
            echo "match=false" >> $GITHUB_OUTPUT
            echo "✗ Version mismatch! Tag: $TAG_VERSION, .version: $FILE_VERSION"
            exit 1
          fi

      - name: Check if release already exists
        id: check-existing-release
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/v$VERSION"

          if curl -s -f "$RELEASE_URL" > /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "⊘ Release v$VERSION already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✓ Release v$VERSION does not exist yet"
          fi

      - name: Check if should release
        id: check-release
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          RELEASE_EXISTS=${{ steps.check-existing-release.outputs.exists }}

          if [ "$RELEASE_EXISTS" = "true" ]; then
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "⊘ Skipping release - v$VERSION already released"
          elif [ "$VERSION" = "0.1.0" ]; then
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "⊘ Skipping release for version 0.1.0 (development version)"
          else
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "✓ Will proceed with release for version $VERSION"
          fi

  build-macos-release:
    name: Build macOS Release
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.93.0
          targets: x86_64-apple-darwin,aarch64-apple-darwin
          components: rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build universal binary
        run: bash scripts/macos/build-universal.sh

      - name: Create app bundle
        run: bash scripts/macos/build-macos-app.sh

      - name: Sign application
        if: env.MACOS_CERTIFICATE != ''
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: bash scripts/macos/sign-app.sh

      - name: Create DMG
        run: bash scripts/macos/create-dmg.sh ${{ needs.check-version.outputs.version }}

      - name: Notarize DMG
        if: env.NOTARIZATION_USERNAME != ''
        env:
          NOTARIZATION_USERNAME: ${{ secrets.NOTARIZATION_USERNAME }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
        run: bash scripts/macos/notarize-app.sh ${{ needs.check-version.outputs.version }}

      - name: Generate checksums
        run: |
          cd target/release
          # List files to debug
          echo "Files in target/release:"
          ls -lah *.dmg 2>/dev/null || echo "No DMG files found"
          
          # Generate checksums for all DMG files
          if ls *.dmg 1> /dev/null 2>&1; then
            shasum -a 256 *.dmg > checksums.sha256
            echo "Checksums generated:"
            cat checksums.sha256
          else
            echo "Error: No DMG files found in target/release"
            exit 1
          fi

      - name: Copy install script
        run: |
          cp scripts/install.sh target/release/install.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release-artifacts
          path: |
            target/release/*.dmg
            target/release/*.sha256
            target/release/install.sh
          retention-days: 90

  create-github-release:
    name: Create GitHub Release
    needs: [check-version, build-macos-release]
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-release-artifacts
          path: ./release-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: Release v${{ needs.check-version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            release-artifacts/*.dmg
            release-artifacts/*.sha256
            release-artifacts/install.sh
          body: |
            # ChaseAI v${{ needs.check-version.outputs.version }}

            ## macOS Distribution

            ### DMG Installer
            - Download `chaseai-${{ needs.check-version.outputs.version }}-macos.dmg`
            - Mount the DMG and drag ChaseAI to Applications folder
            - Verify checksum: `shasum -a 256 -c checksums.sha256`

            ### Homebrew Installation
            ```bash
            brew tap chaseai/chaseai
            brew install chaseai
            ```

            ### Verify Installation
            ```bash
            chaseai --version
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew-formula:
    name: Update Homebrew Formula
    needs: [check-version, create-github-release]
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-release-artifacts
          path: ./release-artifacts

      - name: Calculate DMG checksum
        id: checksum
        run: |
          CHECKSUM=$(shasum -a 256 release-artifacts/*.dmg | awk '{print $1}')
          echo "sha256=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "DMG SHA256: $CHECKSUM"

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: chaseai/homebrew-chaseai
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          VERSION=${{ needs.check-version.outputs.version }}
          SHA256=${{ steps.checksum.outputs.sha256 }}

          cat > homebrew-tap/Formula/chaseai.rb << 'EOF'
          class Chaseai < Formula
            desc "Local control and orchestration system for AI agents"
            homepage "https://github.com/chaseai/chaseai"
            url "https://github.com/chaseai/chaseai/releases/download/v#{version}/chaseai-#{version}-macos.dmg"
            sha256 "${{ steps.checksum.outputs.sha256 }}"
            version "${{ needs.check-version.outputs.version }}"

            def install
              app_path = "ChaseAI.app"
              prefix.install app_path
              bin.write_exec_script "#{prefix}/#{app_path}/Contents/MacOS/chase-ai"
            end

            test do
              system "#{bin}/chase-ai", "--version"
            end
          end
          EOF

      - name: Commit and push formula update
        working-directory: homebrew-tap
        run: |
          git config user.name "ChaseAI Release Bot"
          git config user.email "release@chaseai.local"
          git add Formula/chaseai.rb
          git commit -m "chore: update chaseai formula to v${{ needs.check-version.outputs.version }}"
          git push origin main
        continue-on-error: true
